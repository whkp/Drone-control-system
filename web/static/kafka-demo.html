<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka é›†æˆæ¼”ç¤º - æ— äººæœºæ§åˆ¶ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .demo-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .demo-card:hover {
            transform: translateY(-5px);
        }

        .demo-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .demo-card h3::before {
            content: "ğŸš€";
            margin-right: 10px;
        }

        .demo-card.location h3::before { content: "ğŸ“"; }
        .demo-card.battery h3::before { content: "ğŸ”‹"; }
        .demo-card.task h3::before { content: "ğŸ“‹"; }
        .demo-card.alert h3::before { content: "ğŸš¨"; }

        .demo-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .demo-form input, .demo-form select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .demo-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.3s ease;
        }

        .demo-button:hover {
            opacity: 0.8;
        }

        .demo-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .events-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .events-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .status-dot.connecting {
            background: #ffc107;
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .event-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-time {
            color: #666;
            font-size: 12px;
        }

        .event-type {
            font-weight: bold;
            color: #667eea;
        }

        .event-data {
            margin-top: 5px;
            color: #555;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .clear-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš Kafka é›†æˆæ¼”ç¤º</h1>
            <p>å®æ—¶äº‹ä»¶é©±åŠ¨çš„æ— äººæœºæ§åˆ¶ç³»ç»Ÿ</p>
        </div>

        <!-- æ€§èƒ½æŒ‡æ ‡ -->
        <div class="performance-metrics">
            <div class="metric-card">
                <div class="metric-value" id="eventsCount">0</div>
                <div class="metric-label">äº‹ä»¶æ€»æ•°</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgLatency">0ms</div>
                <div class="metric-label">å¹³å‡å»¶è¿Ÿ</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="throughput">0/s</div>
                <div class="metric-label">ååé‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="errorRate">0%</div>
                <div class="metric-label">é”™è¯¯ç‡</div>
            </div>
        </div>

        <!-- æ¼”ç¤ºæ“ä½œ -->
        <div class="demo-grid">
            <!-- ä½ç½®æ›´æ–°æ¼”ç¤º -->
            <div class="demo-card location">
                <h3>ä½ç½®æ›´æ–°äº‹ä»¶</h3>
                <div class="demo-form">
                    <input type="number" id="droneId1" placeholder="æ— äººæœºID" value="1">
                    <input type="number" id="latitude" placeholder="çº¬åº¦" value="40.7128" step="0.0001">
                    <input type="number" id="longitude" placeholder="ç»åº¦" value="-74.0060" step="0.0001">
                    <input type="number" id="altitude" placeholder="æµ·æ‹”" value="100" step="0.1">
                    <button class="demo-button" onclick="updateLocation()">å‘é€ä½ç½®æ›´æ–°</button>
                </div>
            </div>

            <!-- ç”µé‡ç›‘æ§æ¼”ç¤º -->
            <div class="demo-card battery">
                <h3>ç”µé‡ç›‘æ§äº‹ä»¶</h3>
                <div class="demo-form">
                    <input type="number" id="droneId2" placeholder="æ— äººæœºID" value="1">
                    <input type="number" id="battery" placeholder="ç”µé‡ç™¾åˆ†æ¯”" value="20" min="0" max="100">
                    <button class="demo-button" onclick="updateBattery()">å‘é€ç”µé‡æ›´æ–°</button>
                </div>
            </div>

            <!-- ä»»åŠ¡ç®¡ç†æ¼”ç¤º -->
            <div class="demo-card task">
                <h3>ä»»åŠ¡ç®¡ç†äº‹ä»¶</h3>
                <div class="demo-form">
                    <input type="number" id="taskId" placeholder="ä»»åŠ¡ID" value="1">
                    <select id="taskStatus">
                        <option value="created">å·²åˆ›å»º</option>
                        <option value="started">å·²å¼€å§‹</option>
                        <option value="progress">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="failed">å¤±è´¥</option>
                    </select>
                    <button class="demo-button" onclick="updateTaskStatus()">å‘é€ä»»åŠ¡äº‹ä»¶</button>
                </div>
            </div>

            <!-- æ™ºèƒ½å‘Šè­¦æ¼”ç¤º -->
            <div class="demo-card alert">
                <h3>æ™ºèƒ½å‘Šè­¦ç³»ç»Ÿ</h3>
                <div class="demo-form">
                    <select id="alertType">
                        <option value="battery_low">ç”µé‡ä½</option>
                        <option value="zone_violation">ç¦é£åŒºè¿è§„</option>
                        <option value="communication_loss">é€šä¿¡ä¸¢å¤±</option>
                        <option value="sensor_error">ä¼ æ„Ÿå™¨é”™è¯¯</option>
                    </select>
                    <button class="demo-button" onclick="triggerAlert()">è§¦å‘å‘Šè­¦</button>
                </div>
            </div>
        </div>

        <!-- å®æ—¶äº‹ä»¶æ˜¾ç¤º -->
        <div class="events-panel">
            <div class="events-header">
                <h3>ğŸ”´ å®æ—¶äº‹ä»¶æµ</h3>
                <div class="connection-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">æœªè¿æ¥</span>
                    <button class="clear-button" onclick="clearEvents()">æ¸…ç©º</button>
                </div>
            </div>
            <div class="events-list" id="eventsList">
                <div class="event-item">
                    <div class="event-time">ç­‰å¾…è¿æ¥...</div>
                    <div class="event-type">ç³»ç»ŸçŠ¶æ€</div>
                    <div class="event-data">WebSocketè¿æ¥å‡†å¤‡ä¸­</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let eventCount = 0;
        let startTime = Date.now();
        let latencies = [];
        let errors = 0;

        // è¿æ¥WebSocket
        function connectWebSocket() {
            const wsUrl = 'ws://localhost:8080/ws';
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                updateConnectionStatus('connected', 'å·²è¿æ¥');
                addEvent('connection', 'è¿æ¥å»ºç«‹', { status: 'connected', url: wsUrl });
            };

            ws.onclose = (event) => {
                console.log('WebSocketè¿æ¥å…³é—­:', event);
                updateConnectionStatus('disconnected', 'è¿æ¥æ–­å¼€');
                addEvent('connection', 'è¿æ¥å…³é—­', { code: event.code, reason: event.reason });
                // è‡ªåŠ¨é‡è¿
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
                updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
                addEvent('error', 'WebSocketé”™è¯¯', { error: error.toString() });
                errors++;
                updateMetrics();
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', e);
                    addEvent('error', 'æ¶ˆæ¯è§£æå¤±è´¥', { error: e.toString(), data: event.data });
                }
            };
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            const latency = Date.now() - (data.timestamp ? new Date(data.timestamp).getTime() : Date.now());
            latencies.push(latency);
            if (latencies.length > 100) latencies.shift();

            eventCount++;
            addEvent(data.type, data.type, data.data, latency);
            updateMetrics();
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, text) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        // æ·»åŠ äº‹ä»¶åˆ°åˆ—è¡¨
        function addEvent(type, title, data, latency = null) {
            const eventsList = document.getElementById('eventsList');
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            
            const time = new Date().toLocaleTimeString();
            const latencyText = latency ? ` (${latency}ms)` : '';
            
            eventItem.innerHTML = `
                <div class="event-time">${time}${latencyText}</div>
                <div class="event-type">${title}</div>
                <div class="event-data">${JSON.stringify(data, null, 2)}</div>
            `;
            
            eventsList.insertBefore(eventItem, eventsList.firstChild);
            
            // é™åˆ¶æ˜¾ç¤ºçš„äº‹ä»¶æ•°é‡
            while (eventsList.children.length > 50) {
                eventsList.removeChild(eventsList.lastChild);
            }
        }

        // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
        function updateMetrics() {
            const now = Date.now();
            const elapsed = (now - startTime) / 1000;
            
            document.getElementById('eventsCount').textContent = eventCount;
            
            const avgLatency = latencies.length > 0 ? 
                Math.round(latencies.reduce((a, b) => a + b, 0) / latencies.length) : 0;
            document.getElementById('avgLatency').textContent = avgLatency + 'ms';
            
            const throughput = elapsed > 0 ? (eventCount / elapsed).toFixed(1) : '0';
            document.getElementById('throughput').textContent = throughput + '/s';
            
            const errorRate = eventCount > 0 ? ((errors / eventCount) * 100).toFixed(1) : '0';
            document.getElementById('errorRate').textContent = errorRate + '%';
        }

        // æ¸…ç©ºäº‹ä»¶åˆ—è¡¨
        function clearEvents() {
            document.getElementById('eventsList').innerHTML = '';
            eventCount = 0;
            startTime = Date.now();
            latencies = [];
            errors = 0;
            updateMetrics();
        }

        // å‘é€HTTPè¯·æ±‚çš„é€šç”¨å‡½æ•°
        async function sendRequest(url, method, data) {
            const startTime = Date.now();
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const latency = Date.now() - startTime;
                const result = await response.json();
                
                if (response.ok) {
                    addEvent('api_success', `${method} ${url}`, { 
                        request: data, 
                        response: result,
                        status: response.status 
                    }, latency);
                } else {
                    addEvent('api_error', `${method} ${url}`, { 
                        request: data, 
                        error: result,
                        status: response.status 
                    }, latency);
                    errors++;
                }
            } catch (error) {
                const latency = Date.now() - startTime;
                addEvent('api_error', `${method} ${url}`, { 
                    request: data, 
                    error: error.toString() 
                }, latency);
                errors++;
            }
            updateMetrics();
        }

        // ä½ç½®æ›´æ–°
        function updateLocation() {
            const droneId = document.getElementById('droneId1').value;
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            const altitude = parseFloat(document.getElementById('altitude').value);
            
            sendRequest(`/api/v1/drones/${droneId}/position`, 'PUT', {
                latitude,
                longitude,
                altitude,
                heading: Math.random() * 360
            });

            // ä¸ºä¸‹æ¬¡æµ‹è¯•ç”Ÿæˆéšæœºä½ç½®
            document.getElementById('latitude').value = (latitude + (Math.random() - 0.5) * 0.01).toFixed(4);
            document.getElementById('longitude').value = (longitude + (Math.random() - 0.5) * 0.01).toFixed(4);
        }

        // ç”µé‡æ›´æ–°
        function updateBattery() {
            const droneId = document.getElementById('droneId2').value;
            const battery = parseInt(document.getElementById('battery').value);
            
            sendRequest(`/api/v1/drones/${droneId}/battery`, 'PUT', { battery });

            // ä¸ºä¸‹æ¬¡æµ‹è¯•å‡å°‘ç”µé‡
            const newBattery = Math.max(0, battery - Math.floor(Math.random() * 10 + 1));
            document.getElementById('battery').value = newBattery;
        }

        // ä»»åŠ¡çŠ¶æ€æ›´æ–°
        function updateTaskStatus() {
            const taskId = document.getElementById('taskId').value;
            const status = document.getElementById('taskStatus').value;
            
            // æ¨¡æ‹Ÿä»»åŠ¡çŠ¶æ€æ›´æ–°ï¼ˆè¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºçœŸå®çš„APIè°ƒç”¨ï¼‰
            addEvent('task_update', 'ä»»åŠ¡çŠ¶æ€æ›´æ–°', {
                task_id: parseInt(taskId),
                status: status,
                timestamp: new Date().toISOString()
            });
        }

        // è§¦å‘å‘Šè­¦
        function triggerAlert() {
            const alertType = document.getElementById('alertType').value;
            
            // æ¨¡æ‹Ÿå‘Šè­¦è§¦å‘ï¼ˆè¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºçœŸå®çš„APIè°ƒç”¨ï¼‰
            addEvent('alert_created', 'å‘Šè­¦åˆ›å»º', {
                alert_id: Math.floor(Math.random() * 1000),
                type: alertType,
                level: 'warning',
                message: `æ£€æµ‹åˆ°${alertType}æƒ…å†µ`,
                drone_id: 1,
                timestamp: new Date().toISOString()
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.addEventListener('load', () => {
            connectWebSocket();
            updateMetrics();
        });
    </script>
</body>
</html>
