<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿æ¥çŠ¶æ€æµ‹è¯• - æ— äººæœºæ§åˆ¶ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .metric {
            display: inline-block;
            background: #e9ecef;
            padding: 10px;
            margin: 5px;
            border-radius: 4px;
            text-align: center;
            min-width: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ— äººæœºæ§åˆ¶ç³»ç»Ÿ - è¿æ¥çŠ¶æ€æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ç³»ç»ŸçŠ¶æ€</h2>
            <div id="systemStatus" class="status info">æ­£åœ¨åˆå§‹åŒ–...</div>
            
            <h3>å®æ—¶æŒ‡æ ‡</h3>
            <div id="metrics">
                <div class="metric">
                    <div>æ€»æ— äººæœº</div>
                    <div id="totalDrones">-</div>
                </div>
                <div class="metric">
                    <div>æ´»è·ƒæ— äººæœº</div>
                    <div id="activeDrones">-</div>
                </div>
                <div class="metric">
                    <div>è¿è¡Œä»»åŠ¡</div>
                    <div id="runningTasks">-</div>
                </div>
                <div class="metric">
                    <div>æœªå¤„ç†è­¦æŠ¥</div>
                    <div id="unacknowledgedAlerts">-</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>è¿æ¥æµ‹è¯•</h2>
            <button class="btn" onclick="testAPI()">æµ‹è¯•APIè¿æ¥</button>
            <button class="btn" onclick="testWebSocket()">æµ‹è¯•WebSocket</button>
            <button class="btn" onclick="loadTestData()">åŠ è½½æµ‹è¯•æ•°æ®</button>
            <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            
            <div id="connectionLog" class="log">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <div class="test-section">
            <h2>æ— äººæœºåˆ—è¡¨ (å‰5ä¸ª)</h2>
            <div id="droneList">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let wsConnection = null;
        
        // åˆå§‹åŒ–å‡½æ•°
        async function initialize() {
            log('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹...');
            updateStatus('æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...', 'info');
            
            try {
                // 1. åŠ è½½ä»ªè¡¨æ¿æ•°æ®
                await loadDashboardData();
                log('âœ… ä»ªè¡¨æ¿æ•°æ®åŠ è½½å®Œæˆ');
                
                // 2. åŠ è½½æ— äººæœºåˆ—è¡¨
                await loadDrones();
                log('âœ… æ— äººæœºåˆ—è¡¨åŠ è½½å®Œæˆ');
                
                // 3. å°è¯•WebSocketè¿æ¥
                try {
                    await initializeWebSocket();
                    updateStatus('ç³»ç»Ÿè¿è¡Œæ­£å¸¸ (å®æ—¶è¿æ¥)', 'success');
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                } catch (wsError) {
                    updateStatus('ç³»ç»Ÿè¿è¡Œæ­£å¸¸ (ç¦»çº¿æ¨¡å¼)', 'warning');
                    log('âš ï¸ WebSocketè¿æ¥å¤±è´¥ï¼Œä½†åŸºç¡€åŠŸèƒ½å¯ç”¨: ' + wsError.message);
                }
                
                log('ğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');
                
            } catch (error) {
                updateStatus('åˆå§‹åŒ–å¤±è´¥', 'error');
                log('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ç¡®ä¿åŠŸèƒ½æ­£å¸¸
                const metrics = {
                    total_drones: 12,
                    active_drones: 8,
                    running_tasks: 3,
                    unacknowledged_alerts: 2
                };
                
                document.getElementById('totalDrones').textContent = metrics.total_drones;
                document.getElementById('activeDrones').textContent = metrics.active_drones;
                document.getElementById('runningTasks').textContent = metrics.running_tasks;
                document.getElementById('unacknowledgedAlerts').textContent = metrics.unacknowledged_alerts;
                
                return metrics;
            } catch (error) {
                log('âŒ åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥: ' + error.message);
                throw error;
            }
        }
        
        // åŠ è½½æ— äººæœºåˆ—è¡¨
        async function loadDrones() {
            try {
                let drones = [];
                
                // å°è¯•APIè°ƒç”¨
                try {
                    const response = await axios.get('http://localhost:8080/api/v1/drones', {
                        timeout: 3000
                    });
                    drones = response.data.data || response.data || [];
                    log('ğŸ“¡ ä»APIè·å–æ— äººæœºæ•°æ®: ' + drones.length + ' æ¶');
                } catch (apiError) {
                    log('âš ï¸ APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®: ' + apiError.message);
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    drones = [
                        { id: 1, name: 'Drone-001', model: 'DJI-Mini3', status: 'online', battery: 85 },
                        { id: 2, name: 'Drone-002', model: 'DJI-Air3', status: 'offline', battery: 42 },
                        { id: 3, name: 'Drone-003', model: 'DJI-Phantom4', status: 'flying', battery: 67 },
                        { id: 4, name: 'Drone-004', model: 'DJI-Mavic3', status: 'charging', battery: 23 },
                        { id: 5, name: 'Drone-005', model: 'DJI-Mini2', status: 'online', battery: 91 }
                    ];
                }
                
                displayDroneList(drones.slice(0, 5));
                return drones;
            } catch (error) {
                log('âŒ åŠ è½½æ— äººæœºåˆ—è¡¨å¤±è´¥: ' + error.message);
                throw error;
            }
        }
        
        // æ˜¾ç¤ºæ— äººæœºåˆ—è¡¨
        function displayDroneList(drones) {
            const container = document.getElementById('droneList');
            if (drones.length === 0) {
                container.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°æ— äººæœºæ•°æ®</p>';
                return;
            }
            
            let html = '<table style="width:100%; border-collapse: collapse;">';
            html += '<tr style="background:#f8f9fa;"><th style="padding:8px; border:1px solid #dee2e6;">ID</th><th style="padding:8px; border:1px solid #dee2e6;">åç§°</th><th style="padding:8px; border:1px solid #dee2e6;">å‹å·</th><th style="padding:8px; border:1px solid #dee2e6;">çŠ¶æ€</th><th style="padding:8px; border:1px solid #dee2e6;">ç”µé‡</th></tr>';
            
            drones.forEach(drone => {
                const statusColor = {
                    'online': '#28a745',
                    'flying': '#007bff', 
                    'offline': '#6c757d',
                    'charging': '#ffc107'
                }[drone.status] || '#6c757d';
                
                html += `<tr>
                    <td style="padding:8px; border:1px solid #dee2e6;">${drone.id}</td>
                    <td style="padding:8px; border:1px solid #dee2e6;">${drone.name}</td>
                    <td style="padding:8px; border:1px solid #dee2e6;">${drone.model}</td>
                    <td style="padding:8px; border:1px solid #dee2e6; color:${statusColor}; font-weight:bold;">${drone.status}</td>
                    <td style="padding:8px; border:1px solid #dee2e6;">${drone.battery}%</td>
                </tr>`;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }
        
        // åˆå§‹åŒ–WebSocket
        async function initializeWebSocket() {
            return new Promise((resolve, reject) => {
                try {
                    if (wsConnection) {
                        wsConnection.close();
                    }
                    
                    const wsUrl = 'ws://localhost:50053/ws';
                    log('ğŸ”Œ å°è¯•è¿æ¥ WebSocket: ' + wsUrl);
                    
                    wsConnection = new WebSocket(wsUrl);
                    
                    const timeout = setTimeout(() => {
                        reject(new Error('WebSocketè¿æ¥è¶…æ—¶'));
                    }, 5000);
                    
                    wsConnection.onopen = function(event) {
                        clearTimeout(timeout);
                        log('âœ… WebSocketè¿æ¥å·²å»ºç«‹');
                        resolve(wsConnection);
                    };
                    
                    wsConnection.onmessage = function(event) {
                        log('ğŸ“¨ æ”¶åˆ°WebSocketæ¶ˆæ¯: ' + event.data);
                    };
                    
                    wsConnection.onerror = function(error) {
                        clearTimeout(timeout);
                        log('âŒ WebSocketé”™è¯¯: ' + error);
                        reject(error);
                    };
                    
                    wsConnection.onclose = function(event) {
                        log('ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­: ' + event.code + ' - ' + event.reason);
                    };
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testAPI() {
            log('ğŸ§ª å¼€å§‹APIè¿æ¥æµ‹è¯•...');
            
            const endpoints = [
                'http://localhost:8080/health',
                'http://localhost:8080/api/v1/drones',
                'http://localhost:50053/health'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await axios.get(endpoint, { timeout: 3000 });
                    log(`âœ… ${endpoint}: ${response.status} - OK`);
                } catch (error) {
                    log(`âŒ ${endpoint}: ${error.message}`);
                }
            }
        }
        
        // æµ‹è¯•WebSocketè¿æ¥
        async function testWebSocket() {
            log('ğŸ§ª å¼€å§‹WebSocketè¿æ¥æµ‹è¯•...');
            try {
                await initializeWebSocket();
                log('âœ… WebSocketæµ‹è¯•æˆåŠŸ');
            } catch (error) {
                log('âŒ WebSocketæµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ è½½æµ‹è¯•æ•°æ®
        async function loadTestData() {
            log('ğŸ§ª å¼€å§‹åŠ è½½æµ‹è¯•æ•°æ®...');
            try {
                await loadDashboardData();
                await loadDrones();
                log('âœ… æµ‹è¯•æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                log('âŒ æµ‹è¯•æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type) {
            const statusEl = document.getElementById('systemStatus');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }
        
        // æ—¥å¿—è®°å½•
        function log(message) {
            const logEl = document.getElementById('connectionLog');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('connectionLog').textContent = '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
