<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€å°åŒ–è¿æ¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
        .status-container { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0;
            border: 2px solid #dee2e6;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-dot.connected { background-color: #10B981; }
        .status-dot.connecting { 
            background-color: #F59E0B; 
            animation: pulse 1.5s infinite;
        }
        .status-dot.warning { background-color: #F59E0B; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .log {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ è¿æ¥çŠ¶æ€é—®é¢˜è¯Šæ–­</h1>
    
    <div class="status-container">
        <h3>ğŸ“Š å½“å‰çŠ¶æ€æ˜¾ç¤º</h3>
        <div>
            <span class="status-dot" id="connectionStatus"></span>
            <span id="connectionText">åˆå§‹çŠ¶æ€</span>
        </div>
        <p><strong>é¢„æœŸç»“æœ:</strong> åº”è¯¥ä»"åˆå§‹çŠ¶æ€"å˜ä¸º"å·²è¿æ¥"æˆ–"ç¦»çº¿æ¨¡å¼"</p>
    </div>
    
    <div>
        <h3>ğŸ“‹ å®æ—¶æ—¥å¿—</h3>
        <div id="log" class="log">ç­‰å¾…åˆå§‹åŒ–...</div>
    </div>

    <script>
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateConnectionStatus(status, type = 'info') {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            log(`ğŸ”„ æ­£åœ¨æ›´æ–°çŠ¶æ€: "${status}" (ç±»å‹: ${type})`);
            
            if (!statusElement) {
                log('âŒ é”™è¯¯: æ‰¾ä¸åˆ° connectionStatus å…ƒç´ ');
                return false;
            }
            
            if (!textElement) {
                log('âŒ é”™è¯¯: æ‰¾ä¸åˆ° connectionText å…ƒç´ ');
                return false;
            }
            
            // æ›´æ–°æ–‡æœ¬
            const oldText = textElement.textContent;
            textElement.textContent = status;
            log(`ğŸ“ æ–‡æœ¬å·²æ›´æ–°: "${oldText}" â†’ "${status}"`);
            
            // ç§»é™¤æ—§æ ·å¼
            statusElement.classList.remove('connected', 'connecting', 'warning', 'error', 'disconnected');
            
            // æ·»åŠ æ–°æ ·å¼
            let cssClass = '';
            switch(type) {
                case 'success':
                    cssClass = 'connected';
                    break;
                case 'warning':
                    cssClass = 'warning';
                    break;
                case 'connecting':
                    cssClass = 'connecting';
                    break;
                default:
                    cssClass = 'disconnected';
            }
            
            statusElement.classList.add(cssClass);
            log(`ğŸ¨ æ ·å¼å·²æ›´æ–°: æ·»åŠ ç±» "${cssClass}"`);
            
            return true;
        }
        
        async function loadDashboardData() {
            log('ğŸ“Š å¼€å§‹åŠ è½½ä»ªè¡¨æ¿æ•°æ®...');
            
            // æ¨¡æ‹Ÿæ•°æ®åŠ è½½
            await new Promise(resolve => setTimeout(resolve, 500));
            
            log('âœ… ä»ªè¡¨æ¿æ•°æ®åŠ è½½æˆåŠŸ');
            return { success: true };
        }
        
        async function initializeWebSocket() {
            log('ğŸ”Œ å°è¯•åˆå§‹åŒ–WebSocketè¿æ¥...');
            
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // æ¨¡æ‹Ÿè¿æ¥å¤±è´¥ï¼ˆæ›´çœŸå®çš„æƒ…å†µï¼‰
                    const success = Math.random() > 0.7; // 30% æˆåŠŸç‡
                    
                    if (success) {
                        log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                        resolve(true);
                    } else {
                        log('âŒ WebSocketè¿æ¥å¤±è´¥');
                        reject(new Error('WebSocketè¿æ¥è¶…æ—¶'));
                    }
                }, 1000);
            });
        }
        
        // ä¸»åˆå§‹åŒ–å‡½æ•°
        async function initialize() {
            log('ğŸš€ å¼€å§‹ç³»ç»Ÿåˆå§‹åŒ–...');
            log('ğŸ” æ£€æŸ¥DOMå…ƒç´ ...');
            
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            if (!statusEl || !textEl) {
                log('âŒ è‡´å‘½é”™è¯¯: DOMå…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            log('âœ… DOMå…ƒç´ æ£€æŸ¥é€šè¿‡');
            
            // æ­¥éª¤1: è®¾ç½®åˆå§‹è¿æ¥çŠ¶æ€
            log('ğŸ“¡ è®¾ç½®åˆå§‹è¿æ¥çŠ¶æ€...');
            updateConnectionStatus('æ­£åœ¨åˆå§‹åŒ–...', 'connecting');
            
            try {
                // æ­¥éª¤2: åŠ è½½ä»ªè¡¨æ¿æ•°æ®
                await loadDashboardData();
                log('ğŸ¯ åŸºç¡€æ•°æ®åŠ è½½å®Œæˆï¼Œè®¾ç½®è¿æ¥æˆåŠŸçŠ¶æ€');
                updateConnectionStatus('å·²è¿æ¥', 'success');
                
                // æ­¥éª¤3: å°è¯•WebSocketè¿æ¥ï¼ˆå¯é€‰ï¼‰
                try {
                    await initializeWebSocket();
                    log('ğŸŒ WebSocketè¿æ¥æˆåŠŸï¼Œä¿æŒè¿æ¥çŠ¶æ€');
                    updateConnectionStatus('å®æ—¶è¿æ¥', 'success');
                } catch (wsError) {
                    log('âš ï¸ WebSocketå¤±è´¥ï¼Œä½†åŸºç¡€åŠŸèƒ½å¯ç”¨');
                    updateConnectionStatus('ç¦»çº¿æ¨¡å¼', 'warning');
                }
                
            } catch (error) {
                log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                updateConnectionStatus('è¿æ¥å¤±è´¥', 'error');
            }
            
            log('ğŸ‰ åˆå§‹åŒ–æµç¨‹å®Œæˆ');
        }
        
        // DOMåŠ è½½å®Œæˆåç«‹å³å¼€å§‹
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“‹ DOMå†…å®¹å·²åŠ è½½');
            
            // å»¶è¿Ÿ100msç¡®ä¿é¡µé¢å®Œå…¨æ¸²æŸ“
            setTimeout(() => {
                initialize();
            }, 100);
        });
        
        log('ğŸ“œ è„šæœ¬å·²åŠ è½½ï¼Œç­‰å¾…DOMå‡†å¤‡...');
    </script>
</body>
</html>
